# -*- coding: utf-8 -*-
"""ObrAI - Conversas.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1uSapkbR5q3VnuK1Sw8dI2cc_WSIL7RMu
"""

# Commented out IPython magic to ensure Python compatibility.
# Instala no notebook as ferramentas e fun√ß√µes necess√°rias para usar o SDK da IA Generativa do Google

# %pip -q install google-genai

# Configura a API Key do Google Gemini

import os
from google.colab import userdata

os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')



# Configura o cliente da SDK do Gemini

from google import genai

client = genai.Client()

MODEL_ID = "gemini-2.0-flash"

for model in client.list_models():
  print(model.id)

# Captura a imagem da URL informada pelo usur√°rio
from PIL import Image
import requests
import io
from IPython.display import Image as DisplayImage # Importar com um nome diferente para evitar conflitos

def exibir_imagem_do_colab(url):

     try:
         # Envia uma requisi√ß√£o GET para obter a imagem
         resposta = requests.get(url)
         resposta.raise_for_status()  # Lan√ßa uma exce√ß√£o para c√≥digos de status ruins


         # Abre a imagem a partir do conte√∫do da resposta
         imagem_bytes = io.BytesIO(resposta.content)
         imagem = Image.open(imagem_bytes)


         # Exibe a imagem no Colab
         DisplayImage(imagem) # Utilizo o nome 'DisplayImage' aqui
         return imagem # Retorna o objeto Image para uso posterior, se necess√°rio


     except requests.exceptions.RequestException as e:
         print(f"Erro ao baixar a imagem da URL {url}: {e}")
         return None
     except Exception as e:
         print(f"Erro ao abrir ou exibir a imagem: {e}")
         return None

# Fornece ao Gemini √†s instru√ß√µes a serem consideradas na interpreta√ß√£o da imagem fornecida

from google.genai import types

def interpreta_nota_fiscal(imagem = None, resposta_inicial = None, consideracao_usuario = None):

  chat_config = types.GenerateContentConfig(system_instruction = (
                          """Voc√™ receber√° at√© tr√™s par√¢metros, a url uma nota fiscal no formato de imagem ou pdf e possivelmente sua pr√≥pria resposta,
                          acompanhada uma considera√ß√£o do usu√°rio sobre interpreta√ß√£o da Nota Fiscal.

                          Considerando os par√¢metros recebidos, voc√™ dever√° buscar neste arquivo as seguintes informa√ß√µes:
                          Nome do fornecedor, Data da emiss√£o, N√∫mero da nota fiscal, Descri√ß√£o do produto ou servi√ßo (restrito a um resumo de 50 caracteres, quando aplic√°vel),
                          Quantidade, Valor unit√°rio.
                          Entenda que h√° mais de um padr√£o de nota fiscal. A nota carioca de servi√ßo, por exemplo, possui um padr√£o diferente e a informa√ß√£o do fornecedor
                          poder√° ser encontrada no campo "Prestador de Servi√ßos", j√° a informa√ß√£o da Descri√ß√£o do produto/servi√ßo pode ser encontrada no campo "Discrimina√ß√£o dos Servi√ßos".
                          Caso seja um servi√ßo dever√° ser considerada apenas uma unidade.

                          Voc√™ dever√° confirmar com o usu√°rio se os dados foram interpretados de forma correta.
                          Caso n√£o tenham, voc√™ deve solicitar aux√≠lio do usu√°rio nesta interpreta√ß√£o at√© que esteja correta.
                          A sua resposta final dever√° conter √∫nica e exclusivamente os itens interpreta√ß√£o, conforme modelo apresentado abaixo.

                          Caso a nota fiscal possua mais de um item, voc√™ deve repetir os dados comuns para cada item, respeitando o template apresentado a seguir:

                          ##### Item 1 #####

                          Nome do fornecedor: FERRAGENS BUARQUE MACEDO EIRELLI
                          Data de emiss√£o: 16/01/2025
                          N√∫mero da nota fiscal: 365045
                          Descri√ß√£o do produto/servi√ßo: CANT.ALUM.TL C 3MT 1 2
                          Quantidade: 2
                          Valor unit√°rio: 12,950000

                          ##### Item 2 #####

                          Nome do fornecedor: FERRAGENS BUARQUE MACEDO EIRELLI
                          Data de emiss√£o: 16/01/2025
                          N√∫mero da nota fiscal: 365045
                          Descri√ß√£o do produto/servi√ßo: TRI PARAF.PHI.C CHATA 2,5X25 11 4X4
                          Quantidade: 10
                          Valor unit√°rio: 12,950000

                          Se voc√™ n√£o conseguir ler exatamente as informa√ß√µes da nota fiscal fornecida, dever√° dizer: 'N√£o foi poss√≠vel ler o arquivo!'
                          Tamb√©m dever√° apresentar uma justificativa para n√£o ter conseguido ler"""))

  chat = client.chats.create(model = MODEL_ID, config= chat_config)

  mensagem = imagem
  if consideracao_usuario:
    mensagem = f"A sua resposta foi: {resposta_inicial}\n\nConsidera√ß√£o do usu√°rio: {consideracao_usuario}"

  resposta = chat.send_message(mensagem)

  return resposta.text

# Instala Framework ADK de agentes do Google
!pip install -q google-adk

from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.genai import types  # Para criar conte√∫dos (Content e Part)
import requests # Para fazer requisi√ß√µes HTTP
import warnings

warnings.filterwarnings("ignore")

# Fun√ß√£o auxiliar que envia uma mensagem para um agente via Runner e retorna a resposta final
def call_agent(agent: Agent, message_text: str) -> str:
    # Cria um servi√ßo de sess√£o em mem√≥ria
    session_service = InMemorySessionService()
    # Cria uma nova sess√£o (voc√™ pode personalizar os IDs conforme necess√°rio)
    session = session_service.create_session(app_name=agent.name, user_id="user1", session_id="session1")
    # Cria um Runner para o agente
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    # Cria o conte√∫do da mensagem de entrada
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    # Itera assincronamente pelos eventos retornados durante a execu√ß√£o do agente
    for event in runner.run(user_id="user1", session_id="session1", new_message=content):
        if event.is_final_response():
          for part in event.content.parts:
            if part.text is not None:
              final_response += part.text
              final_response += "\n"
    return final_response

################################################
# --- Agente 1: Categorizador de Gastos 1 --- #
################################################
def agente_categorizador_1(resultado_interpretacao, consideracao_usuario_categorizacao = None):
    categorizador_1 = Agent(
        name="agente_categorizador_1",
        model="gemini-2.0-flash",
        # Inserir as instru√ß√µes do 1¬∫ Agente Categorizador
        instruction="""
        Voc√™ √© um categorizador de gastos. Voc√™ receber√° como par√¢metros os gastos contantes de uma nota fiscal e, possivelmente, as considera√ß√µes do usu√°rio sobre a sua tentativa de categoriza√ß√£o.

        Poder√° ter um ou mais gastos nesta nota.
        Sua fun√ß√£o ser√° adicionar o campo "Tipo de Gasto 1" para cada um dos itens (ou item) que lhe for informado.
        Para isso voc√™ dever√° classificar os itens seguindo, necessariamente, alguma das categorias a seguir:
        Alvenaria
        Hidraulica
        El√©trica
        Marcenaria
        M√≥veis
        Pintura
        Eletrodom√©sticos
        Caso n√£o consiga classificar em nenhum destes itens, dever√° colocar o r√≥tulo Outras Despesas.

        Voc√™ receber√° os itens conforme a lista a seguir:

        Item 1
        Nome do fornecedor: FERRAGENS BUARQUE MACEDO EIRELLI
        Data de emiss√£o: 16/01/2025
        N√∫mero da nota fiscal: 365045
        Descri√ß√£o do produto/servi√ßo: TIJOLO 29X39
        Quantidade: 200
        Valor unit√°rio: 12,950000

        Item 2
        Nome do fornecedor: FERRAGENS BUARQUE MACEDO EIRELLI
        Data de emiss√£o: 16/01/2025
        N√∫mero da nota fiscal: 365045
        Descri√ß√£o do produto/servi√ßo: TRI PARAF.PHI.C CHATA 2,5X25 11 4X4
        Quantidade: 10
        Valor unit√°rio: 0,500000

        Seguindo este exemplo o seu output dever√° ser:

        Item 1
        Nome do fornecedor: FERRAGENS BUARQUE MACEDO EIRELLI
        Data de emiss√£o: 16/01/2025
        N√∫mero da nota fiscal: 365045
        Descri√ß√£o do produto/servi√ßo: TIJOLO 29X39
        Quantidade: 200
        Valor unit√°rio: 12,950000
        Tipo de Gasto 1: Alvenaria

        Item 2
        Nome do fornecedor: FERRAGENS BUARQUE MACEDO EIRELLI
        Data de emiss√£o: 16/01/2025
        N√∫mero da nota fiscal: 365045
        Descri√ß√£o do produto/servi√ßo: TRI PARAF.PHI.C CHATA 2,5X25 11 4X4
        Quantidade: 10
        Valor unit√°rio: 0,500000
        Tipo de Gasto 1: Outras Despesas

        Voc√™ dever√° solicitar a confirma√ß√£o do usu√°rio de que os dados foram classificados de forma correta.
        Caso n√£o tenham, voc√™ deve solicitar aux√≠lio do usu√°rio nesta primeira classifica√ß√£o at√© que a classifica√ß√£o esteja correta.
        A sua resposta final dever√° conter √∫nica e exclusivamente os itens da primeira classifica√ß√£o, conforme modelo apresentado acima.

        """,
        description="Agente que categoriza gastos em notas fiscais",
    )



    if consideracao_usuario_categorizacao:
      entrada_do_agente_categorizador_1 = f"Os dados da Nota Fiscal: {resultado_interpretacao}\n\nConsidera√ß√£o do usu√°rio: {consideracao_usuario_categorizacao}"
    else:
      entrada_do_agente_categorizador_1 = f"Os dados da Nota Fiscal:{resultado_interpretacao}\n"


    # Executa o agente
    dados_categorizados_1 = call_agent(categorizador_1, entrada_do_agente_categorizador_1)
    return dados_categorizados_1

######################################
# --- Agente 2: Categorizador 2 --- #
######################################
def agente_categorizador_2(dados_categorizados_1, consideracao_usuario_categorizacao_2 = None):
    categorizador_2 = Agent(
        name="agente_redator",
        model="gemini-2.0-flash",
        # Inserir as instru√ß√µes do 2¬∫ Agente Categorizador
        instruction="""
            Voc√™ √© um agente categorizador. Sua fun√ß√£o √© analizar as informa√ß√µes oriundas de uma nota fiscal, que foram previamente
            categorizadas no campo "Tipo de Gasto 1" e inserir o campo "Tipo de Gasto 2" que dever√° receber um dos dois valores: "N√£o Incorpor√°vel ao IR" e "Incorpor√°vel ao IR".
            Para realizar esta classifica√ß√£o, voc√™ dever√° analisar os campos Descri√ß√£o do produto/servi√ßo e "Tipo de Gasto 1" com a finalidade de entender se aquele pode ou n√£o ser
            um gasto que pode ser incorporado ao valor venal do im√≥vel no momento da declara√ß√£o do imposto de renda pessoa f√≠sica.
            √â algo parecido com o que acontece na contabilidade gerencial, em que custos e despesas (OPEX) n√£o podem ser incorporadas ao imobilizado e investimentos podem.
            Em geral, itens que ficam soltos como eletrodom√©sticos e m√≥veis n√£o podem ser incorporados ao IR. Mas a marcenaria, por exemplo, pode ser incorporado.

            Voc√™ receber√° os itens conforme a lista a seguir:

            Item 1
            Nome do fornecedor: FERRAGENS BUARQUE MACEDO EIRELLI
            Data de emiss√£o: 16/01/2025
            N√∫mero da nota fiscal: 365045
            Descri√ß√£o do produto/servi√ßo: TIJOLO 29X39
            Quantidade: 200
            Valor unit√°rio: 12,950000
            Tipo de Gasto 1: Alvenaria

            Item 2
            Nome do fornecedor: FERRAGENS BUARQUE MACEDO EIRELLI
            Data de emiss√£o: 16/01/2025
            N√∫mero da nota fiscal: 365045
            Descri√ß√£o do produto/servi√ßo: TRI PARAF.PHI.C CHATA 2,5X25 11 4X4
            Quantidade: 10
            Valor unit√°rio: 0,500000
            Tipo de Gasto 1: Outras Despesas

            Seguindo este exemplo o seu output dever√° ser:

            Item 1
            Nome do fornecedor: FERRAGENS BUARQUE MACEDO EIRELLI
            Data de emiss√£o: 16/01/2025
            N√∫mero da nota fiscal: 365045
            Descri√ß√£o do produto/servi√ßo: TIJOLO 29X39
            Quantidade: 200
            Valor unit√°rio: 12,950000
            Tipo de Gasto 1: Alvenaria
            Tipo de Gasto 2: Incorpor√°vel ao IR

            Item 2
            Nome do fornecedor: FERRAGENS BUARQUE MACEDO EIRELLI
            Data de emiss√£o: 16/01/2025
            N√∫mero da nota fiscal: 365045
            Descri√ß√£o do produto/servi√ßo: TRI PARAF.PHI.C CHATA 2,5X25 11 4X4
            Quantidade: 10
            Valor unit√°rio: 0,500000
            Tipo de Gasto 1: Outras Despesas
            Tipo de Gasto 2: N√£o Incorpor√°vel ao IR

            Voc√™ dever√° solicitar a confirma√ß√£o do usu√°rio de que os dados foram classificados de forma correta.
            Caso n√£o tenham, voc√™ deve solicitar aux√≠lio do usu√°rio nesta segunda classifica√ß√£o.

            """,
        description="Agente que categoriza gastos em notas fiscais para fins de Imposto de Renda"
    )

    if consideracao_usuario_categorizacao_2:
      entrada_do_agente_categorizador_2 = f"Os dados da Nota Fiscal: {dados_categorizados_1}\n\nConsidera√ß√£o do usu√°rio: {consideracao_usuario_categorizacao_2}"

    else:
      entrada_do_agente_categorizador_2 = f"Itens constantes da Nota fiscal a ser analisada:{dados_categorizados_1}\n"


    # Executa o agente
    dados_categorizados_2 = call_agent(categorizador_2, entrada_do_agente_categorizador_2)
    return dados_categorizados_2

##########################################
# --- Agente 3: Gerador de JSon --- #
##########################################
def agente_gerador_json(dados_categorizados_2):
    gerador_json = Agent(
        name="agente_gerador_json",
        model="gemini-2.0-flash",
        # Inserir as instru√ß√µes do Agente Gerador de Json
        instruction="""
            Voc√™ √© um gerador de json. Voc√™ receber√° os dados classificados dos gastos de uma nota fiscal e dever√° gerar o conte√∫do de um arquivo json,
            que ser√° incorporado em um banco de dados. Seu output ser√° apenas o arquivo json, que dever√° sempre ter a mesma estrutura, conforme apresentado a seguir:
            {
                "Nome do fornecedor": "FERRAGENS BUARQUE MACEDO EIRELLI",
                "Data de emiss√£o": "06/12/2024",
                "N√∫mero da nota fiscal": "361735",
                "Descri√ß√£o do produto/servi√ßo": "M COTOV.90 ROSC. 3 4",
                "Quantidade": 5,
                "Valor unit√°rio": 14.700000,
                "Tipo de Gasto 1": "Hidraulica",
                "Tipo de Gasto 2": "Incorpor√°vel ao IR"
              }

            """,
        description="Agente gerador de json."
    )
    entrada_gerador_json = f"Gerar json: {dados_categorizados_2}"
    # Executa o agente
    arquivo_json = call_agent(gerador_json, entrada_gerador_json)
    return arquivo_json

print("ü™öüõ†Ô∏èü™õüß∞ Iniciando o Sistema ObrA√ç ü™öüõ†Ô∏èü™õüß∞")

# --- Obter a URL da imagem da Nota Fiscal  ---

url_da_imagem = input("Por favor, insira a URL da Nota Fiscal que voc√™ deseja interpretar e confira o resultado ao final: ")

# Exibe a imagem
imagem = exibir_imagem_do_colab(url_da_imagem)

# Verifica se a imagem foi aberta com sucesso e prossegue se sim
if imagem:
    print("Imagem exibida com sucesso no Colab.")
    # Obt√©m as dimens√µes da Imagem para verificar se foi devidamente carregada
    largura, altura = imagem.size
    print(f"A imagem tem largura {largura} e altura {altura}.")
    # Inicia a fun√ß√£o de interpreta√ß√£o da Nota Fiscal
    resposta_interpretacao = interpreta_nota_fiscal(imagem)
    print(resposta_interpretacao)

# Questiona o usu√°rio se o Agente interpretou corretamente a Nota Fiscal e entra no Loop para que a corre√ß√£o seja feita
    resultado_interpretacao = input("Interpretei corretamente as Notas Fiscais? Caso negativo, apresente a justificativa, por favor ")

    while resultado_interpretacao.lower().strip() not in "sim":
      resposta_interpretacao = interpreta_nota_fiscal(resposta_inicial = resposta_interpretacao, consideracao_usuario = resultado_interpretacao)
      print(resposta_interpretacao)
      resultado_interpretacao = input("E agora, interpretei corretamente as Notas Fiscais? Caso negativo, apresente a justificativa, por favor ")

else:
    print("N√£o foi poss√≠vel exibir a imagem.")

# L√≥gica do sistema de agentes

# Carrega os dados j√° processados da Nota Fiscal para que o Gemini fa√ßa a primeira rotina de classifica√ß√£o
dados_categorizados_1 = agente_categorizador_1(resultado_interpretacao=resposta_interpretacao)
print("\n --- Resultado do Agente Categorizador 1 --- \n")
print(dados_categorizados_1)

# Questiona o usu√°rio se o Agente categorizou conforme a natureza da despesa corretamente a Nota Fiscal e entra no Loop para que a corre√ß√£o seja feita
resultado_categorizacao_1 = input("Categorizei corretamente as Notas Fiscais? Caso negativo, apresente a justificativa, por favor ")

while resultado_categorizacao_1.lower().strip() not in "sim":
  dados_categorizados_1 = agente_categorizador_1(resultado_interpretacao = resposta_interpretacao, consideracao_usuario_categorizacao = resultado_categorizacao_1)
  print("\n --- Resultado do Agente Categorizador 1 --- \n")
  print(dados_categorizados_1)
  resultado_categorizacao_1 = input("E agora, interpretei corretamente as Notas Fiscais? Caso negativo, apresente a justificativa, por favor ")

# Carrega os dados j√° processador e classificados para que o Gemini fa√ßa a segunda rotina de classifica√ß√£o
dados_categorizados_2 = agente_categorizador_2(dados_categorizados_1 = dados_categorizados_1)
print("\n --- Resultado do Agente Categorizador 2 --- \n")
print(dados_categorizados_2)

# Questiona o usu√°rio se o Agente categorizou conforme a possibilidade de incorpora√ß√£o ao valor do im√≥vel da despesa corretamente a Nota Fiscal e entra no Loop para que a corre√ß√£o seja feita
resultado_categorizacao_2 = input("Categorizei corretamente as Notas Fiscais? Caso negativo, apresente a justificativa, por favor ")

while resultado_categorizacao_2.lower().strip() not in "sim":
  dados_categorizados_2 = agente_categorizador_2(dados_categorizados_1 = dados_categorizados_1, consideracao_usuario_categorizacao_2 = resultado_categorizacao_2)
  print("\n --- Resultado do Agente Categorizador 2 --- \n")
  print(dados_categorizados_2)
  resultado_categorizacao_2 = input("E agora, interpretei corretamente as Notas Fiscais? Caso negativo, apresente a justificativa, por favor ")

# Carrega os dados totalmente classificados para que se gere o arquivo Json com os dados a serem, futuramente, incorporados ao Banco de Dados
arquivo_json = agente_gerador_json(dados_categorizados_2=dados_categorizados_2)

print("\n --- Resultado do Agente Gerador de JSON --- \n")
print(arquivo_json)
print("----------------------------------------------------")